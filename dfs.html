<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng DFS - Bồi dưỡng HSG Tin học</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        .grid-cell {
            transition: all 0.2s ease;
            position: relative;
        }
        .coord-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            font-weight: 800;
            opacity: 0.6;
            pointer-events: none;
        }
        #logContainer::-webkit-scrollbar {
            width: 6px;
        }
        #logContainer::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #logContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .log-entry {
            animation: fadeIn 0.3s ease-out;
            border-left: 3px solid transparent;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        /* Modal Style */
        #guideModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #guideModal.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Modal Hướng dẫn -->
    <div id="guideModal" onclick="toggleGuide()">
        <div class="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="toggleGuide()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-2xl font-extrabold text-slate-800 mb-6 flex items-center gap-3 border-b pb-4">
                <i data-lucide="help-circle" class="text-blue-500 w-8 h-8"></i> Hướng dẫn sử dụng
            </h2>
            <div class="space-y-6 text-slate-600 overflow-y-auto max-h-[60vh] pr-2">
                <section>
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-2 italic">
                        <i data-lucide="mouse-pointer-2" class="w-4 h-4"></i> Ý nghĩa các chế độ vẽ chuột:
                    </h3>
                    <ul class="space-y-3">
                        <li class="flex gap-3">
                            <span class="bg-slate-800 text-white p-1 rounded h-fit shrink-0"><i data-lucide="square" class="w-4 h-4 fill-current"></i></span>
                            <div>
                                <strong class="text-slate-800">Đặt vật cản (Phím 1):</strong> Click chuột vào ô để biến nó thành tường. DFS sẽ không thể đi qua ô này.
                            </div>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-green-500 text-white p-1 rounded h-fit shrink-0"><i data-lucide="home" class="w-4 h-4"></i></span>
                            <div>
                                <strong class="text-slate-800">Đặt Bắt đầu (Phím 2):</strong> Click chuột để đặt điểm xuất phát (gốc đệ quy).
                            </div>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-red-500 text-white p-1 rounded h-fit shrink-0"><i data-lucide="flag" class="w-4 h-4"></i></span>
                            <div>
                                <strong class="text-slate-800">Đặt Kết thúc (Phím 3):</strong> Click chuột để đặt đích đến. DFS dừng lại khi tìm thấy ô này.
                            </div>
                        </li>
                    </ul>
                </section>
                <section>
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-2 italic">
                        <i data-lucide="zap" class="w-4 h-4"></i> Quy trình mô phỏng:
                    </h3>
                    <ol class="list-decimal pl-5 space-y-2">
                        <li>Chọn <strong>N x M</strong> để thay đổi kích thước bản đồ.</li>
                        <li>Sử dụng các <strong>chế độ vẽ</strong> để thiết lập chướng ngại vật và điểm đi/đến.</li>
                        <li>Nhấn <strong>CHẠY DFS</strong> để bắt đầu quá trình duyệt.</li>
                        <li>Theo dõi <strong>Nhật ký</strong> và <strong>Stack</strong> bên dưới để hiểu luồng đệ quy.</li>
                    </ol>
                </section>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-[11px] font-medium leading-relaxed">
                    <strong>Mẹo:</strong> Thứ tự ưu tiên hướng của thuật toán là <strong>Trên → Dưới → Trái → Phải</strong>. 
                    Bạn có thể thấy trong nhật ký khi hệ thống đẩy các tọa độ lân cận vào ngăn xếp theo thứ tự ngược lại để đảm bảo lấy ra đúng ưu tiên (LIFO).
                </div>
            </div>
            <button onclick="toggleGuide()" class="w-full mt-8 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition-colors">ĐÃ HIỂU</button>
        </div>
    </div>

    <div class="flex flex-col min-h-screen p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight underline decoration-blue-500 decoration-4 underline-offset-8">Mô phỏng DFS (Toạ độ & Nhật ký)</h1>
            <p class="text-slate-500 mt-4 font-medium uppercase text-xs tracking-widest">Công cụ bồi dưỡng HSG Tin học THCS</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 max-w-7xl mx-auto w-full">
            <!-- Cột trái: Điều khiển (3 cols) -->
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-4 border-b pb-2">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-slate-700">
                            <i data-lucide="settings" class="w-5 h-5 text-blue-500"></i> Cấu hình
                        </h2>
                        <button onclick="toggleGuide()" class="text-blue-500 hover:text-blue-700 transition-colors flex items-center gap-1 text-[10px] font-black uppercase">
                            <i data-lucide="help-circle" class="w-5 h-5"></i> HDSD
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Hàng (N)</label>
                                <input type="number" id="inputRows" value="4" min="2" max="10" 
                                    class="w-full p-2 bg-slate-50 border-2 border-slate-100 rounded-lg outline-none font-bold">
                            </div>
                            <div class="flex-1">
                                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Cột (M)</label>
                                <input type="number" id="inputCols" value="4" min="2" max="12" 
                                    class="w-full p-2 bg-slate-50 border-2 border-slate-100 rounded-lg outline-none font-bold">
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Chế độ vẽ chuột</label>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="setEditMode('wall')" id="btnWall" class="mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-slate-800 border-slate-900 text-white flex items-center gap-3">
                                    <i data-lucide="square" class="w-4 h-4 fill-current"></i> Đặt vật cản (Phím 1)
                                </button>
                                <button onclick="setEditMode('start')" id="btnStart" class="mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-white border-slate-100 text-slate-400 flex items-center gap-3">
                                    <i data-lucide="home" class="w-4 h-4"></i> Đặt Bắt đầu (Phím 2)
                                </button>
                                <button onclick="setEditMode('end')" id="btnEnd" class="mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-white border-slate-100 text-slate-400 flex items-center gap-3">
                                    <i data-lucide="flag" class="w-4 h-4"></i> Đặt Kết thúc (Phím 3)
                                </button>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase">Tốc độ</label>
                                <span id="speedVal" class="text-xs font-mono font-bold text-blue-600">500ms</span>
                            </div>
                            <input type="range" id="inputSpeed" min="50" max="1500" step="50" value="500" class="w-full accent-blue-600">
                        </div>

                        <button id="runBtn" onclick="startSimulation()" class="w-full py-4 rounded-xl font-black text-sm bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-5 h-5 fill-current"></i> CHẠY DFS
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
                    <h3 class="text-xs font-black text-slate-400 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="layers" class="w-4 h-4 text-amber-500"></i> Stack hiện tại
                    </h3>
                    <div id="stackContainer" class="flex flex-wrap gap-2 min-h-[100px] content-start">
                        <span class="text-[10px] text-slate-300 italic">Trống</span>
                    </div>
                </div>
            </div>

            <!-- Cột giữa & phải: Grid và Log (9 cols) -->
            <div class="lg:col-span-9 space-y-6">
                <!-- Khu vực Lưới -->
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 relative overflow-hidden">
                    <div id="statusAlert" class="hidden absolute top-4 right-4 p-3 bg-green-500 text-white rounded-xl flex items-center gap-2 z-30 shadow-lg animate-bounce">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span class="font-bold text-xs uppercase tracking-tight">Tìm thấy đích!</span>
                    </div>

                    <div id="gridContainer" class="grid gap-2 mx-auto transition-all duration-500">
                        <!-- Ô lưới tạo bởi JS -->
                    </div>

                    <!-- Nhật ký chạy thuật toán -->
                    <div class="mt-8 border-t pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xs font-black text-slate-400 uppercase flex items-center gap-2">
                                <i data-lucide="list-todo" class="w-4 h-4 text-blue-500"></i> Nhật ký thuật toán (Step-by-Step)
                            </h3>
                            <button onclick="clearLog()" class="text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors">XOÁ NHẬT KÝ</button>
                        </div>
                        <div id="logContainer" class="bg-slate-900 rounded-xl p-4 h-48 overflow-y-auto font-mono text-[11px] space-y-1 shadow-inner">
                            <div class="text-slate-500 italic">// Hệ thống sẵn sàng. Nhấn 'CHẠY DFS' để bắt đầu...</div>
                        </div>
                    </div>
                </div>

                <!-- Source Code -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button onclick="setLang('cpp')" id="langCpp" class="px-4 py-2 rounded-lg text-xs font-black bg-white text-blue-600 shadow-sm">C++</button>
                            <button onclick="setLang('py')" id="langPy" class="px-4 py-2 rounded-lg text-xs font-black text-slate-500">PYTHON</button>
                        </div>
                        <div class="text-[10px] font-bold text-slate-400">Ưu tiên: Trên -> Dưới -> Trái -> Phải</div>
                    </div>
                    <pre id="codeDisplay" class="text-emerald-400 text-xs font-mono bg-slate-900 p-4 rounded-xl overflow-x-auto border-l-4 border-blue-500"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let rows = 4, cols = 4;
        let grid = [
            [0, 0, 1, 0],
            [1, 0, 1, 0],
            [0, 0, 0, 0],
            [1, 1, 1, 0]
        ];
        let startNode = { r: 0, c: 0 }, endNode = { r: 3, c: 3 };
        let isRunning = false, editMode = 'wall', speed = 500, language = 'cpp';
        let visited = new Set(), pathCells = [];

        const cppSource = `void dfs(int x, int y) {
    visited[x][y] = true;
    int dx[] = {-1, 1, 0, 0}, dy[] = {0, 0, -1, 1};

    for (int k = 0; k < 4; k++) {
        int nx = x + dx[k], ny = y + dy[k];
        if (nx >= 0 && nx < n && ny >= 0 && ny < m) {
            if (grid[nx][ny] == 0 && !visited[nx][ny])
                dfs(nx, ny);
        }
    }
}`;
        const pySource = `def dfs(x, y):
    visited[x][y] = True
    dx, dy = [-1, 1, 0, 0], [0, 0, -1, 1]
    for k in range(4):
        nx, ny = x + dx[k], y + dy[k]
        if 0 <= nx < n and 0 <= ny < m:
            if grid[nx][ny] == 0 and not visited[nx][ny]:
                dfs(nx, ny)`;

        window.onload = () => {
            lucide.createIcons();
            initControls();
            renderGrid();
            updateCode();
            
            // Lắng nghe phím tắt 1, 2, 3
            document.addEventListener('keydown', (e) => {
                if (e.key === '1') setEditMode('wall');
                if (e.key === '2') setEditMode('start');
                if (e.key === '3') setEditMode('end');
            });
        };

        function toggleGuide() {
            document.getElementById('guideModal').classList.toggle('show');
        }

        function initControls() {
            document.getElementById('inputRows').onchange = (e) => { rows = parseInt(e.target.value); resetGrid(); };
            document.getElementById('inputCols').onchange = (e) => { cols = parseInt(e.target.value); resetGrid(); };
            document.getElementById('inputSpeed').oninput = (e) => { 
                speed = parseInt(e.target.value); 
                document.getElementById('speedVal').innerText = speed + 'ms'; 
            };
        }

        function setEditMode(mode) {
            editMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.className = "mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-white border-slate-100 text-slate-400 flex items-center gap-3 transition-all";
            });
            const btn = mode === 'wall' ? 'btnWall' : (mode === 'start' ? 'btnStart' : 'btnEnd');
            const el = document.getElementById(btn);
            if (mode === 'wall') el.className = "mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-slate-800 border-slate-900 text-white flex items-center gap-3 shadow-lg";
            else if (mode === 'start') el.className = "mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-green-50 border-green-500 text-green-700 flex items-center gap-3 shadow-md";
            else el.className = "mode-btn p-2 text-[10px] font-bold rounded-lg border-2 bg-red-50 border-red-500 text-red-700 flex items-center gap-3 shadow-md";
        }

        function resetGrid() {
            grid = Array(rows).fill().map(() => Array(cols).fill(0));
            startNode = { r: 0, c: 0 };
            endNode = { r: rows - 1, c: cols - 1 };
            clearSim();
            renderGrid();
            addLog("Đã làm mới bản đồ kích thước " + rows + "x" + cols, "system");
        }

        function clearSim() {
            visited = new Set();
            pathCells = [];
            isRunning = false;
            document.getElementById('statusAlert').classList.add('hidden');
            renderGrid();
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="text-slate-500 italic">// Nhật ký đã xoá.</div>';
        }

        function addLog(msg, type = "info") {
            const container = document.getElementById('logContainer');
            const div = document.createElement('div');
            let color = "text-slate-300";
            let prefix = ">> ";
            let border = "border-slate-700";

            if (type === "visit") { color = "text-blue-400"; prefix = "[THĂM] "; border = "border-blue-500"; }
            if (type === "stack") { color = "text-amber-400"; prefix = "[STACK] "; border = "border-amber-500"; }
            if (type === "found") { color = "text-green-400"; prefix = "[ĐÍCH] "; border = "border-green-500"; }
            if (type === "wall") { color = "text-red-400"; prefix = "[CHẶN] "; }
            if (type === "system") { color = "text-slate-500"; prefix = "# "; }

            div.className = `log-entry p-1 pl-2 ${color} border-l-2 ${border}`;
            div.innerText = prefix + msg;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function renderGrid(current = null) {
            const container = document.getElementById('gridContainer');
            container.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            container.innerHTML = '';

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = `grid-cell aspect-square border-2 rounded-xl cursor-pointer flex items-center justify-center`;
                    
                    const label = document.createElement('span');
                    label.className = "coord-label";
                    label.innerText = `(${r},${c})`;
                    cell.appendChild(label);

                    const isStart = startNode.r === r && startNode.c === c;
                    const isEnd = endNode.r === r && endNode.c === c;
                    const isWall = grid[r][c] === 1;
                    const isVisited = visited.has(`${r}-${c}`);
                    const isCurrent = current && current.r === r && current.c === c;
                    const isInPath = pathCells.some(p => p.r === r && p.c === c);

                    if (isWall) cell.classList.add('bg-slate-800', 'border-slate-900');
                    else if (isCurrent) cell.classList.add('bg-yellow-400', 'border-yellow-600', 'scale-105', 'z-20', 'shadow-xl');
                    else if (isStart) cell.classList.add('bg-green-500', 'border-green-700');
                    else if (isEnd) cell.classList.add('bg-red-500', 'border-red-700');
                    else if (isInPath) cell.classList.add('bg-yellow-200', 'border-yellow-400');
                    else if (isVisited) cell.classList.add('bg-blue-400', 'border-blue-600');
                    else cell.classList.add('bg-white', 'border-slate-200', 'hover:bg-slate-50');

                    if (isStart) cell.insertAdjacentHTML('beforeend', '<i data-lucide="home" class="w-1/2 h-1/2 text-white opacity-80"></i>');
                    if (isEnd) cell.insertAdjacentHTML('beforeend', '<i data-lucide="flag" class="w-1/2 h-1/2 text-white opacity-80"></i>');

                    cell.onclick = () => {
                        if (isRunning) return;
                        if (editMode === 'wall') grid[r][c] = grid[r][c] === 1 ? 0 : 1;
                        else if (editMode === 'start' && grid[r][c] === 0) startNode = { r, c };
                        else if (editMode === 'end' && grid[r][c] === 0) endNode = { r, c };
                        clearSim();
                    };
                    container.appendChild(cell);
                }
            }
            lucide.createIcons();
        }

        async function startSimulation() {
            if (isRunning) return;
            isRunning = true;
            visited = new Set();
            pathCells = [];
            clearLog();
            addLog(`Bắt đầu DFS từ (${startNode.r}, ${startNode.c})...`, "system");
            
            const stack = [{ r: startNode.r, c: startNode.c, p: [] }];
            
            while (stack.length > 0) {
                updateStackUI(stack);
                const curr = stack.pop();
                const { r, c, p } = curr;
                const key = `${r}-${c}`;

                if (visited.has(key)) {
                    addLog(`Bỏ qua (${r},${c}) vì đã thăm.`, "system");
                    continue;
                }

                visited.add(key);
                addLog(`Đang tại ô (${r},${c}). Đánh dấu visited[${r}][${c}] = true`, "visit");
                renderGrid({ r, c });

                const newPath = [...p, { r, c }];

                if (r === endNode.r && c === endNode.c) {
                    pathCells = newPath;
                    addLog(`Tìm thấy đích tại (${r},${c})!`, "found");
                    document.getElementById('statusAlert').classList.remove('hidden');
                    renderGrid();
                    isRunning = false;
                    return;
                }

                await new Promise(res => setTimeout(res, speed));

                const dr = [-1, 1, 0, 0], dc = [0, 0, -1, 1];
                const labels = ["TRÊN", "DƯỚI", "TRÁI", "PHẢI"];

                for (let i = 3; i >= 0; i--) {
                    const nr = r + dr[i], nc = c + dc[i];
                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
                        if (grid[nr][nc] === 1) {
                            addLog(`Hướng ${labels[i]} (${nr},${nc}) là VẬT CẢN.`, "wall");
                        } else if (!visited.has(`${nr}-${nc}`)) {
                            addLog(`Đẩy hướng ${labels[i]} (${nr},${nc}) vào Stack.`, "stack");
                            stack.push({ r: nr, c: nc, p: newPath });
                        }
                    }
                }
            }
            addLog("Kết thúc: Không tìm thấy đường đi.", "wall");
            isRunning = false;
            renderGrid();
        }

        function updateStackUI(stack) {
            const container = document.getElementById('stackContainer');
            container.innerHTML = '';
            stack.forEach(s => {
                const item = document.createElement('div');
                item.className = "px-2 py-1 bg-amber-50 text-amber-700 text-[9px] font-black border border-amber-200 rounded shadow-sm";
                item.innerText = `(${s.r},${s.c})`;
                container.appendChild(item);
            });
        }

        function setLang(l) { 
            language = l; 
            updateCode(); 
            document.getElementById('langCpp').className = l === 'cpp' ? 'px-4 py-2 rounded-lg text-xs font-black bg-white text-blue-600 shadow-sm' : 'px-4 py-2 rounded-lg text-xs font-black text-slate-500';
            document.getElementById('langPy').className = l === 'py' ? 'px-4 py-2 rounded-lg text-xs font-black bg-white text-blue-600 shadow-sm' : 'px-4 py-2 rounded-lg text-xs font-black text-slate-500';
        }
        function updateCode() { document.getElementById('codeDisplay').innerText = language === 'cpp' ? cppSource : pySource; }
    </script>
</body>
</html>