<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Phân Tích Kết Quả - Giảng Viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700;800&display=swap');
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .error-item { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Trung Tâm Báo Cáo</h1>
                <p class="text-slate-500 font-medium">Theo dõi tiến độ và phân tích lỗ hổng kiến thức</p>
            </div>
            <div class="flex items-center gap-3">
                <select id="sheet-selector" onchange="fetchData(this.value)" class="bg-slate-50 border border-slate-200 font-bold py-3 px-6 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <option value="K7">Khối 7</option>
                    <option value="K9">Khối 9</option>
                    <option value="KT7">KT 7</option>
                    <option value="KT9">KT 9</option>
                </select>
                <button onclick="fetchData(document.getElementById('sheet-selector').value)" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-2xl shadow-lg transition-all active:scale-95">
                    <i class="fa-solid fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-5">
                <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fa-solid fa-user-graduate"></i></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tổng số bài</p><h2 id="stat-total" class="text-3xl font-extrabold">0</h2></div>
            </div>
            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-5">
                <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fa-solid fa-star"></i></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Trung bình</p><h2 id="stat-avg" class="text-3xl font-extrabold">0</h2></div>
            </div>
            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-5">
                <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fa-solid fa-chart-pie"></i></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tỉ lệ đạt</p><h2 id="stat-pass" class="text-3xl font-extrabold text-emerald-600">0%</h2></div>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-8 flex flex-wrap gap-5 items-end">
            <div class="flex-1 min-w-[300px]">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block ml-1">Tìm kiếm học sinh</label>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    <input type="text" id="search-name" oninput="applyFilters()" placeholder="Nhập tên..." class="w-full pl-12 pr-4 py-3 bg-slate-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            <div class="w-full md:w-auto">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block ml-1">Lọc Lớp</label>
                <select id="filter-class" onchange="applyFilters()" class="w-full px-6 py-3 bg-slate-50 rounded-2xl font-bold text-slate-600 border-none outline-none"></select>
            </div>
            <div class="w-full md:w-auto">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block ml-1 text-blue-500">Chế độ xem</label>
                <select id="sort-type" onchange="applyFilters()" class="w-full px-6 py-3 bg-blue-50 text-blue-700 rounded-2xl font-bold border-none outline-none ring-2 ring-blue-100">
                    <option value="stt-asc">STT Tăng dần</option>
                    <option value="score-desc">Điểm số Giảm dần</option>
                </select>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-100">
                            <th class="px-6 py-5 font-bold text-slate-500 text-[10px] uppercase">Lớp</th>
                            <th class="px-6 py-4 font-bold text-slate-500 text-[10px] uppercase text-center">STT</th>
                            <th class="px-6 py-5 font-bold text-slate-500 text-[10px] uppercase">Học sinh</th>
                            <th class="px-6 py-5 font-bold text-slate-500 text-[10px] uppercase text-center">Điểm</th>
                            <th class="px-6 py-5 font-bold text-slate-500 text-[10px] uppercase">Phân tích lỗi</th>
                            <th class="px-6 py-5 font-bold text-slate-500 text-[10px] uppercase text-center">Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="data-body" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
            <div id="loading" class="p-20 text-center">
                <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-500 mb-3"></i>
                <p class="text-slate-400 font-bold text-xs uppercase tracking-widest">Đang tải dữ liệu bài làm...</p>
            </div>
        </div>
    </div>

    <div id="modal-error" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0 pointer-events-none z-50">
        <div class="modal-overlay absolute w-full h-full bg-slate-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-3xl shadow-2xl z-50 overflow-y-auto max-h-[80vh]">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-extrabold text-slate-800">Chi tiết các câu sai</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div id="modal-content" class="space-y-4">
                    </div>
                <button onclick="closeModal()" class="w-full mt-8 bg-slate-800 text-white font-bold py-4 rounded-2xl hover:bg-black transition-all">ĐÓNG CỬA SỔ</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyN-3m_Z_-3Z6yaj_FO1NhGAlICmheLfCG-_LfPWgKOLYHixbvvJzlH2KN9vy97Z7oc/exec";
        let masterData = [];

                let allQuestions = [];

        // Hàm tải file JSON chứa câu hỏi (copy code bạn gửi)
        async function loadQuestions() {
            try {
                const response = await fetch('t9cde1.json'); // Đảm bảo đúng tên file JSON của bạn
                if (!response.ok) throw new Error('Không thể tải file dữ liệu câu hỏi');
                
                allQuestions = await response.json();
                console.log("✅ Đã tải dữ liệu tra cứu:", allQuestions.length, "câu hỏi.");
            } catch (error) {
                console.error("Lỗi:", error);
                // Không alert để tránh phiền nếu chỉ xem báo cáo nhanh
            }
        }

      
        loadQuestions();

        const getVal = (obj, keys) => {
            const foundKey = Object.keys(obj).find(k => keys.includes(k.trim()));
            return foundKey ? obj[foundKey] : "";
        };

        async function fetchData(sheet = "K7") {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            document.getElementById('data-body').innerHTML = '';
            try {
                const response = await fetch(`${API_URL}?sheet=${encodeURIComponent(sheet)}`);
                masterData = await response.json();
                updateClassFilter();
                applyFilters();
                updateStats(masterData);
            } catch (error) {
                console.error("Lỗi API:", error);
            } finally {
                loading.classList.add('hidden');
            }
        }


        // HÀM HIỂN THỊ MODAL LỖI SAI
        function openErrorModal(errorString, studentName) {
            const container = document.getElementById('modal-content');
            const items = errorString.split(' || ');
            
            container.innerHTML = `<p class="mb-4 text-slate-500">Học sinh: <span class="font-bold text-blue-600">${studentName}</span></p>`;
            
            items.forEach(item => {
                // Chuỗi có dạng: "Q01(Sai: A | Đúng: B)"
                const parts = item.split('(');
                const qId = parts[0].trim(); // Lấy ID (ví dụ: "Q01")
                
                const detail = parts[1] ? parts[1].replace(')', '') : "";
                const subParts = detail.split(' | ');
                const sai = subParts[0] ? subParts[0].replace('Sai: ', '') : "";
                const dung = subParts[1] ? subParts[1].replace('Đúng: ', '') : "";

                // --- TRA CỨU NỘI DUNG CÂU HỎI ---
                let questionContent = qId; // Mặc định hiển thị ID nếu chưa tải được data
                
                // Tìm câu hỏi trong mảng allQuestions có id trùng với qId
                if (allQuestions.length > 0) {
                    const foundQ = allQuestions.find(q => String(q.id) === String(qId));
                    if (foundQ) {
                        questionContent = foundQ.q; // Lấy nội dung câu hỏi thay thế cho ID
                    }
                }
                // -------------------------------

                container.innerHTML += `
                    <div class="error-item bg-rose-50 p-4 rounded-2xl mb-3">
                        <div class="font-bold text-slate-800 text-sm mb-3 border-b border-rose-200 pb-2">
                            <span class="inline-block bg-rose-200 text-rose-700 text-[10px] px-2 py-0.5 rounded mr-2 align-middle">${qId}</span>
                            ${questionContent}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Học sinh chọn:</p>
                                <p class="text-sm font-bold text-rose-600">${sai}</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Đáp án đúng:</p>
                                <p class="text-sm font-bold text-emerald-600">${dung}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            const modal = document.getElementById('modal-error');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('modal-error');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        async function deleteRow(timestamp, name) {
            if (!confirm(`Xóa kết quả của học sinh "${name}"?`)) return;
            const currentSheet = document.getElementById('sheet-selector').value;
            try {
                const response = await fetch(`${API_URL}?action=delete&sheet=${encodeURIComponent(currentSheet)}&timestamp=${encodeURIComponent(timestamp)}&name=${encodeURIComponent(name)}`, { method: 'POST' });
                const res = await response.text();
                if (res === "SUCCESS") { fetchData(currentSheet); }
            } catch (err) { alert("Lỗi khi xóa."); }
        }

        function applyFilters() {
            const nameSearch = document.getElementById('search-name').value.toLowerCase();
            const classFilter = document.getElementById('filter-class').value;
            const sortType = document.getElementById('sort-type').value;

            let filtered = masterData.filter(item => {
                const name = String(getVal(item, ['Họ Tên'])).toLowerCase();
                const cls = String(getVal(item, ['Lớp']));
                return name.includes(nameSearch) && (classFilter === "" || cls === classFilter);
            });

            // Sắp xếp
            filtered.sort((a, b) => {
                const clsA = String(getVal(a, ['Lớp']));
                const clsB = String(getVal(b, ['Lớp']));
                if (clsA !== clsB) return clsA.localeCompare(clsB);
                if (sortType === 'stt-asc') return (parseInt(getVal(a, ['STT'])) || 0) - (parseInt(getVal(b, ['STT'])) || 0);
                return (parseFloat(getVal(b, ['Điểm Số', 'Điểm'])) || 0) - (parseFloat(getVal(a, ['Điểm Số', 'Điểm'])) || 0);
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const body = document.getElementById('data-body');
            body.innerHTML = data.map(item => {
                const name = getVal(item, ['Họ Tên']);
                const score = parseFloat(getVal(item, ['Điểm Số', 'Điểm'])) || 0;
                const errorLog = getVal(item, ['ID câu hỏi', 'questionIds']); // Cột chứa logic sai
                const isPerfect = errorLog.includes("Không sai câu nào") || errorLog === "";
                const timestamp = getVal(item, ['Thời gian', 'Timestamp']);

                return `
                <tr class="hover:bg-blue-50/40 transition-all">
                    <td class="px-6 py-4"><span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-xl text-[10px] font-black uppercase">${getVal(item, ['Lớp'])}</span></td>
                    <td class="px-6 py-4 text-center font-bold text-slate-400 text-sm">${getVal(item, ['STT'])}</td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${name}</div>
                        <div class="text-[9px] text-slate-300 font-medium">${new Date(timestamp).toLocaleString('vi-VN')}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-xl font-black ${score >= 5 ? 'text-blue-600' : 'text-rose-500'}">${score}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${isPerfect ? 
                            `<span class="text-emerald-500 text-xs font-bold italic"><i class="fa-solid fa-check-double mr-1"></i>Hoàn hảo</span>` : 
                            `<button onclick="openErrorModal('${errorLog.replace(/'/g, "\\'")}', '${name}')" class="bg-rose-50 text-rose-600 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-rose-100 transition-all">
                                <i class="fa-solid fa-magnifying-glass-chart mr-1"></i> XEM ${errorLog.split(' || ').length} LỖI
                            </button>`
                        }
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteRow('${timestamp}', '${name}')" class="text-slate-200 hover:text-rose-600 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        function updateClassFilter() {
            const classes = [...new Set(masterData.map(item => getVal(item, ['Lớp'])))].filter(Boolean).sort();
            const select = document.getElementById('filter-class');
            select.innerHTML = '<option value="">Tất cả</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateStats(data) {
            const total = data.length;
            const scores = data.map(item => parseFloat(getVal(item, ['Điểm Số', 'Điểm'])) || 0);
            const avg = total > 0 ? (scores.reduce((a, b) => a + b, 0) / total).toFixed(1) : 0;
            const passRate = total > 0 ? Math.round((scores.filter(s => s >= 5).length / total) * 100) : 0;
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-avg').innerText = avg;
            document.getElementById('stat-pass').innerText = passRate + "%";
        }

        fetchData();
    </script>
</body>
</html>