<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Trắc nghiệm Tin học 7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .option-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid #e5e7eb;
        }
        .option-card:hover {
            border-color: #667eea;
            background-color: #f3f4ff;
        }
        .option-card.selected {
            border-color: #667eea;
            background-color: #e0e7ff;
            font-weight: 600;
        }
        .review-card {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }
    </style>
</head>
<body>

    <div id="intro-section" class="glass-morphism p-8 max-w-md w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">BÀI KIỂM TRA</h1>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Họ và Tên</label>
                <input type="text" id="student-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nhập họ tên...">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lớp</label>
                    <input type="text" id="student-class" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="7A1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Số thứ tự (STT)</label>
                    <input type="number" id="student-stt" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="01">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Chọn chủ đề kiểm tra</label>
                <select id="topic-select" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md bg-white">
                    <option value="tt">Tìm kiếm tuần tự</option>
                    <option value="np">Tìm kiếm nhị phân</option>
                    <option value="sxc">Sắp xếp chọn</option>
                    <option value="sxnb">Sắp xếp nổi bọt</option>
                </select>
            </div>
            <button onclick="startQuiz()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-300 mt-4">
                BẮT ĐẦU LÀM BÀI
            </button>
        </div>
    </div>

    <div id="quiz-section" class="glass-morphism p-8 max-w-3xl w-full hidden">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <div>
                <h2 id="display-topic" class="text-xl font-bold text-indigo-800">Chủ đề</h2>
                <p id="display-info" class="text-sm text-gray-600 italic"></p>
            </div>
            <div id="timer" class="text-lg font-mono font-bold text-red-600 bg-red-50 px-4 py-1 rounded-full border border-red-200">
                <p class="text-indigo-600 font-semibold">
                    Tiến độ: <span id="answered-count">0</span>/10 câu
                </p>
            </div>
        </div>

        <div id="question-container" class="space-y-6">
            </div>

        <div class="mt-8 flex justify-end">
            <button onclick="submitQuiz()" class="bg-emerald-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-emerald-700 transition">
                NỘP BÀI
            </button>
        </div>
    </div>

    <div id="result-section" class="glass-morphism p-8 max-w-2xl w-full hidden">
        <div class="text-center mb-8">
            <div id="score-circle" class="w-32 h-32 rounded-full border-8 border-indigo-500 flex items-center justify-center text-3xl font-bold mx-auto mb-4 text-indigo-600">
                0/10
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Kết Quả Làm Bài</h2>
            <p id="result-student-info" class="text-gray-600"></p>
        </div>

        <div id="wrong-answers-section" class="mt-6 border-t pt-6 hidden">
            <h3 class="text-lg font-bold text-red-600 mb-4">Các câu cần xem lại:</h3>
            <div id="wrong-answers-list" class="space-y-4 max-h-60 overflow-y-auto pr-2"></div>
        </div>

        <button onclick="location.reload()" class="w-full mt-8 bg-gray-200 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-300">
            LÀM LẠI BÀI KHÁC
        </button>
    </div>

    <script>
        let allQuestions = []; // Ban đầu để mảng rỗng
        let selectedQuestions = [];
        let studentAnswers = [];

        // HÀM TẢI DỮ LIỆU TỪ FILE JSON
        async function loadQuestions() {
            try {
                const response = await fetch('tin7cdF.json'); // Đường dẫn đến file json
                if (!response.ok) {
                    throw new Error('Không thể tải file dữ liệu câu hỏi');
                }
                allQuestions = await response.json();
                console.log("Đã tải dữ liệu thành công:", allQuestions.length, "câu hỏi.");
            } catch (error) {
                console.error("Lỗi:", error);
                alert("Lỗi tải dữ liệu. Vui lòng kiểm tra file questions.json!");
            }
        }

        // Gọi hàm tải dữ liệu ngay khi trang web vừa load xong
        window.onload = loadQuestions;

        async function startQuiz() {
            const name = document.getElementById('student-name').value.trim();
            const className = document.getElementById('student-class').value.trim();
            const stt = document.getElementById('student-stt').value.trim();
            const topic = document.getElementById('topic-select').value;

            // Kiểm tra xem dữ liệu đã tải xong chưa
            if (allQuestions.length === 0) {
                await loadQuestions(); // Thử tải lại nếu chưa có
            }

            if (!name || !className || !stt) {
                alert("Vui lòng điền đầy đủ thông tin học sinh!");
                return;
            }

            // Lọc câu hỏi theo chủ đề (Logic giữ nguyên)
            let pool = allQuestions.filter(q => q.topic === topic);
            
            if (pool.length === 0) {
                alert("Không tìm thấy câu hỏi cho chủ đề này!");
                return;
            }

            selectedQuestions = pool.sort(() => Math.random() - 0.5).slice(0, 10);
            studentAnswers = new Array(selectedQuestions.length).fill(null);

            document.getElementById('display-topic').innerText = "Chủ đề: " + document.getElementById('topic-select').selectedOptions[0].text;
            document.getElementById('display-info').innerText = `Học sinh: ${name} - Lớp: ${className} - STT: ${stt}`;
            
            document.getElementById('intro-section').classList.add('hidden');
            document.getElementById('quiz-section').classList.remove('hidden');

            renderQuestions();
        }

    function renderQuestions() {
        const container = document.getElementById('question-container');
        container.innerHTML = '';

        selectedQuestions.forEach((q, idx) => {
            const qDiv = document.createElement('div');
            qDiv.className = "p-4 border rounded-xl bg-gray-50 mb-4";
            qDiv.innerHTML = `
                <p class="font-bold text-gray-800 mb-4">${idx + 1}. ${q.question}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${q.options.map((opt, i) => `
                        <div onclick="selectOption(${idx}, ${i})" id="opt-${idx}-${i}" class="option-card p-3 rounded-lg bg-white border-2">
                            ${opt}
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(qDiv);
        });
    }

    // Hàm tính số câu đã làm
    
    function updateProgress() {
        /*
            Vì mảng studentAnswers được khởi tạo là [null, null, ..., null]. 
            Khi HS click vào một đáp án, giá trị null tại vị trí đó sẽ được thay bằng số (0, 1, 2, 3). 
            SD Hàm filter để lọc ra các vị trí đã có đáp án, giúp đếm đúng số câu HS đã làm.
        */
        // Đếm số lượng phần tử trong mảng studentAnswers không phải là null
        const answeredCount = studentAnswers.filter(ans => ans !== null).length;
        
        // Cập nhật con số hiển thị trên giao diện
        const countEl = document.getElementById('answered-count');
        if (countEl) {
            countEl.innerText = answeredCount;
        }

        // (Tùy chọn) Thêm hiệu ứng đổi màu khi hoàn thành 10/10
        if (answeredCount === 10) {
            countEl.parentElement.classList.remove('text-indigo-600');
            countEl.parentElement.classList.add('text-emerald-600');
        }
    }

    function selectOption(qIdx, optIdx) {
        studentAnswers[qIdx] = optIdx;
        // Lấy số lượng options thực tế của câu hỏi đó
        const numOptions = selectedQuestions[qIdx].options.length; 
        // Xóa class 'selected' ở các lựa chọn của câu hỏi
        for(let i=0; i < numOptions; i++) {
            const el = document.getElementById(`opt-${qIdx}-${i}`);
            if(el) {
                el.classList.remove('selected', 'bg-indigo-100', 'border-indigo-500');
            }
        }
        // Thêm class selected cho lựa chọn mới
        const selectedEl = document.getElementById(`opt-${qIdx}-${optIdx}`);
        selectedEl.classList.add('selected', 'bg-indigo-100', 'border-indigo-500');

        // GỌI HÀM CẬP NHẬT TIẾN ĐỘ Sau khi học sinh làm xong 1 câu hỏi
        updateProgress();
    }
    

    function submitQuiz() {
        if (studentAnswers.includes(null)) {
            if (!confirm("Bạn chưa làm hết các câu. Vẫn muốn nộp bài?")) return;
        }

        let score = 0;
        const wrongList = document.getElementById('wrong-answers-list');
        wrongList.innerHTML = '';

        selectedQuestions.forEach((q, i) => {
            if (studentAnswers[i] === q.answer) {
                score++;
            } else {
                const div = document.createElement('div');
                div.className = "review-card p-4 rounded-xl border-l-4 border-red-500 bg-red-50 mb-3";
                div.innerHTML = `
                    <p class="font-bold text-gray-800 mb-1">Câu ${i + 1}: ${q.question}</p>
                    <p class="text-sm text-red-600 italic">Em chọn: ${studentAnswers[i] !== null ? q.options[studentAnswers[i]] : 'Bỏ trống'}</p>
                    <p class="text-sm text-emerald-600 font-bold">Đáp án đúng: ${q.options[q.answer]}</p>
                `;
                wrongList.appendChild(div);
            }
        });

        document.getElementById('score-circle').innerText = `${score}/10`;
        document.getElementById('result-student-info').innerText = document.getElementById('display-info').innerText;
        
        if (score < 10) {
            document.getElementById('wrong-answers-section').classList.remove('hidden');
        } else {
            document.getElementById('wrong-answers-section').classList.add('hidden');
        }

        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('result-section').classList.remove('hidden');
        window.scrollTo(0, 0);
    }
</script>
</body>
</html>