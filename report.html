<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-800">Dashboard Quản Lý Điểm</h1>
                <p class="text-slate-500">Hệ thống lọc dữ liệu theo Thẻ (Sheet) và Lớp</p>
            </div>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg active:scale-95">
                <i class="fa-solid fa-rotate"></i> CẬP NHẬT DỮ LIỆU
            </button>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6 flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px] relative">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="search-name" placeholder="Tìm tên học sinh..." class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            
            <div class="flex items-center gap-2">
                <span class="text-sm font-bold text-slate-400 uppercase">Thẻ:</span>
                <select id="filter-sheet" class="px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 border-blue-500 outline-none min-w-[120px] bg-slate-50 font-bold text-blue-600">
                    <option value="">Tất cả</option>
                </select>
            </div>

            <div class="flex items-center gap-2">
                <span class="text-sm font-bold text-slate-400 uppercase">Lớp:</span>
                <select id="filter-class" class="px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 border-blue-500 outline-none min-w-[120px]">
                    <option value="">Tất cả</option>
                </select>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-100">
                    <tr>
                        <th class="px-6 py-4 font-bold text-slate-700">Thẻ</th>
                        <th class="px-6 py-4 font-bold text-slate-700">Lớp</th>
                        <th class="px-6 py-4 font-bold text-slate-700">Họ và Tên</th>
                        <th class="px-6 py-4 font-bold text-slate-700 text-center">Điểm số</th>
                        <th class="px-6 py-4 font-bold text-slate-700">Thời gian nộp</th>
                    </tr>
                </thead>
                <tbody id="data-body" class="divide-y divide-slate-50"></tbody>
            </table>
            <div id="loading" class="p-12 text-center text-slate-400"> Đang tải dữ liệu từ Google Sheets... </div>
        </div>
    </div>

    <script>
        const API_URL = "LINK_WEB_APP_CỦA_BẠN"; // Nhớ dán link Apps Script vào đây
        let masterData = [];

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const response = await fetch(API_URL);
                masterData = await response.json();
                masterData.reverse(); 

                updateDropdowns(); // Cập nhật cả 2 bộ lọc
                renderTable(masterData);
                updateStats(masterData);
            } catch (error) {
                console.error("Lỗi:", error);
                alert("Lỗi kết nối dữ liệu!");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Cập nhật danh sách Thẻ và Lớp từ dữ liệu thực tế
        function updateDropdowns() {
            // Lấy danh sách Thẻ duy nhất
            const sheets = [...new Set(masterData.map(item => item.sheetName || item.Thẻ))].filter(Boolean).sort();
            const sheetSelect = document.getElementById('filter-sheet');
            sheetSelect.innerHTML = '<option value="">Tất cả</option>';
            sheets.forEach(s => sheetSelect.innerHTML += `<option value="${s}">${s}</option>`);

            // Lấy danh sách Lớp duy nhất
            const classes = [...new Set(masterData.map(item => item.userClass || item.Lớp))].filter(Boolean).sort();
            const classSelect = document.getElementById('filter-class');
            classSelect.innerHTML = '<option value="">Tất cả</option>';
            classes.forEach(c => classSelect.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function renderTable(data) {
            const body = document.getElementById('data-body');
            body.innerHTML = data.map(item => `
                <tr class="hover:bg-blue-50/50 transition-colors">
                    <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-mono border">${item.sheetName || item.Thẻ || '-'}</span></td>
                    <td class="px-6 py-4"><span class="font-bold text-blue-600">${item.userClass || item.Lớp}</span></td>
                    <td class="px-6 py-4 font-semibold text-slate-800">${item.name}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-lg font-black ${item.score >= (item.totalQuestions/2) ? 'text-green-600' : 'text-red-500'}">
                            ${item.score}/${item.totalQuestions}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-xs text-slate-400">${new Date(item.timestamp).toLocaleString('vi-VN')}</td>
                </tr>
            `).join('');
        }

        // Sự kiện lọc đa tầng
        document.getElementById('search-name').addEventListener('input', applyFilters);
        document.getElementById('filter-class').addEventListener('change', applyFilters);
        document.getElementById('filter-sheet').addEventListener('change', applyFilters);

        function applyFilters() {
            const nameSearch = document.getElementById('search-name').value.toLowerCase();
            const classFilter = document.getElementById('filter-class').value;
            const sheetFilter = document.getElementById('filter-sheet').value;

            const filtered = masterData.filter(item => {
                const matchName = item.name.toLowerCase().includes(nameSearch);
                const matchClass = classFilter === "" || (item.userClass || item.Lớp) === classFilter;
                const matchSheet = sheetFilter === "" || (item.sheetName || item.Thẻ) === sheetFilter;
                return matchName && matchClass && matchSheet;
            });

            renderTable(filtered);
            updateStats(filtered); // Cập nhật thống kê theo kết quả đã lọc
        }

        function updateStats(data) {
            if (data.length === 0) {
                document.getElementById('stat-total').innerText = 0;
                document.getElementById('stat-avg').innerText = 0;
                document.getElementById('stat-pass').innerText = "0%";
                return;
            }
            const total = data.length;
            const avg = (data.reduce((sum, item) => sum + Number(item.score), 0) / total).toFixed(1);
            const passCount = data.filter(item => (item.score / item.totalQuestions) >= 0.5).length;
            const passRate = ((passCount / total) * 100).toFixed(0);

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-avg').innerText = avg;
            document.getElementById('stat-pass').innerText = passRate + "%";
        }

        fetchData();
    </script>
</body>