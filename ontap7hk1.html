<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc Nghiệm Tin Học 7 - Chủ Đề D (Trộn Đề)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            --primary-color: #0084ff;
            --secondary-color: #e0f2fe;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --text-color: #334155;
            --bg-color: #f0f9ff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            width: 95%;
            max-width: 800px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        h1 { margin: 0; font-size: 1.5rem; }
        h2 { margin: 5px 0 0; font-size: 1rem; font-weight: 400; opacity: 0.9; }

        /* Screens */
        .screen {
            padding: 30px;
            flex-grow: 1;
            display: none; /* Hidden by default */
            flex-direction: column;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Login Form */
        .form-group {
            margin-bottom: 20px;
        }
       
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
        }

        /* UPDATE: Thêm select vào CSS để đồng bộ giao diện */
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
            background-color: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, background 0.3s;
            display: inline-block;
            text-align: center;
            user-select: none;
        }

        .btn:hover { background: #0066cc; }
        .btn:active { transform: scale(0.98); }

        .btn-secondary {
            background: #94a3b8;
        }
        .btn-secondary:hover { background: #64748b; }

        .btn-submit {
            background: var(--success-color);
        }
        .btn-submit:hover { background: #059669; }
       
        .btn-danger {
            background: var(--error-color);
        }
        .btn-danger:hover { background: #dc2626; }

        /* Quiz UI */
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .timer {
            font-weight: 700;
            color: var(--error-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .question-number {
            font-weight: 700;
            color: var(--primary-color);
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options-grid {
            display: grid;
            gap: 15px;
        }

        .option-card {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .option-card:hover {
            border-color: var(--primary-color);
            background: var(--secondary-color);
        }

        .option-card.selected {
            border-color: var(--primary-color);
            background: var(--secondary-color);
            position: relative;
        }

        .option-card.selected::after {
            content: '✓';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-weight: bold;
        }

        .option-letter {
            font-weight: 700;
            min-width: 25px;
            color: var(--primary-color);
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 20px;
        }

        /* Progress Bar */
        .progress-container {
            height: 6px;
            background: #e2e8f0;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
       
        .progress-bar {
            height: 100%;
            background: var(--success-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* Results */
        .score-box {
            background: var(--secondary-color);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .score-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        .info-summary {
            text-align: center;
            margin-bottom: 20px;
            color: #64748b;
        }

        .review-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
        }

        .review-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
       
        .review-item:last-child { border-bottom: none; }

        .review-q { font-weight: 700; margin-bottom: 8px; }
       
        .review-ans {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-top: 5px;
            display: block;
        }
       
        .correct-ans { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .wrong-ans { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .user-ans-label { font-weight: 600; font-size: 0.8rem; text-transform: uppercase; margin-right: 5px; }

        /* Modal/Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 99;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
       
        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
       
        .modal-overlay.active {
            display: flex;
        }
       
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
       
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-color);
        }
       
        .modal-body {
            margin-bottom: 20px;
            color: #64748b;
        }
       
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
       
        .badge-random {
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 10px;
            vertical-align: middle;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
       
        <header>
            <h1>Trắc Nghiệm Tin Học 7 <span class="badge-random">Đề Trộn</span></h1>
            <h2>Chủ đề D: Đạo đức, pháp luật và văn hoá trong môi trường số</h2>
        </header>

        <div id="screen-login" class="screen active">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="https://cdn-icons-png.flaticon.com/512/3408/3408545.png" alt="Icon" width="80" style="margin-bottom: 10px;">
                <p>Chào mừng các em! Bài kiểm tra gồm <strong>30 câu hỏi</strong> trong <strong>10 phút</strong>.</p>
                <p style="color: var(--primary-color); font-size: 0.9rem;"><i>*Lưu ý: Câu hỏi và đáp án sẽ được trộn ngẫu nhiên.</i></p>
            </div>
           
            <div class="form-group">
                <label>Họ và tên học sinh:</label>
                <input type="text" id="input-name" placeholder="Nhập họ tên đầy đủ...">
            </div>
            
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label>Lớp:</label>
                    <select id="input-class">
                        <option value="" disabled selected>Chọn lớp</option>
                        <option value="7.1">7.1</option>
                        <option value="7.2">7.2</option>
                        <option value="7.3">7.3</option>
                        <option value="7.4">7.4</option>
                        <option value="7.5">7.5</option>
                        <option value="7.6">7.6</option>
                        <option value="7.7">7.7</option>
                        <option value="7.8">7.8</option>
                        <option value="7.9">7.9</option>
                        <option value="7.10">7.10</option>
                        <option value="7.11">7.11</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>STT (1-55):</label>
                    <input type="number" id="input-id" placeholder="STT" min="1" max="55">
                </div>
            </div>
            
            <button class="btn" onclick="startQuiz()" style="width: 100%; margin-top: 10px;">Bắt đầu làm bài</button>
        </div>

        <div id="screen-quiz" class="screen">
            <div class="quiz-header">
                <div class="question-number">Câu hỏi <span id="q-current">1</span>/30</div>
                <div class="timer">⏱ <span id="timer-display">10:00</span></div>
            </div>

            <div class="question-text" id="question-text">Loading...</div>
           
            <div class="options-grid" id="options-container">
                </div>

            <div class="nav-buttons">
                <button class="btn btn-secondary" id="btn-prev" onclick="prevQuestion()">Quay lại</button>
                <button class="btn" id="btn-next" onclick="nextQuestion()">Câu tiếp theo</button>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="info-summary" id="result-info"></div>
           
            <div class="score-box">
                <div>Điểm số của bạn</div>
                <div class="score-number" id="score-display">0/30</div>
                <div id="score-percent"></div>
            </div>

            <h3 style="margin-bottom: 10px;">Xem lại bài làm:</h3>
            <div class="review-list" id="review-list">
                </div>

            <button class="btn" onclick="location.reload()" style="width: 100%; margin-top: 20px;">Làm lại bài mới</button>
        </div>
    </div>

    <div id="toast">Thông báo</div>
   
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">Nộp bài?</div>
            <div class="modal-body" id="modal-body">Bạn có chắc chắn muốn nộp bài không?</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Xem lại</button>
                <button class="btn btn-submit" onclick="submitQuiz()">Nộp bài</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // Original data source
        const rawQuestionsDB =[
  {
    "id": 1,
    "q": "Thiết bị nào sau đây là thiết bị vào của máy tính?",
    "options": [
      "A. Loa, tai nghe",
      "B. Chuột, bàn phím",
      "C. Màn hình, máy in",
      "D. Máy chiếu, loa"
    ],
    "correct": "B"
  },
  {
    "id": 2,
    "q": "Thiết bị nào sau đây là thiết bị ra của máy tính?",
    "options": [
      "A. Bàn phím",
      "B. Chuột",
      "C. Loa",
      "D. Webcam"
    ],
    "correct": "C"
  },
  {
    "id": 3,
    "q": "Hệ điều hành là phần mềm có chức năng:",
    "options": [
      "A. Soạn thảo văn bản",
      "B. Quản lí và điều khiển máy tính",
      "C. Vẽ hình",
      "D. Nghe nhạc"
    ],
    "correct": "B"
  },
  {
    "id": 4,
    "q": "Trong Windows, trình quản lí hệ thống tệp là:",
    "options": [
      "A. Word",
      "B. Excel",
      "C. File Explorer",
      "D. PowerPoint"
    ],
    "correct": "C"
  },
  {
    "id": 5,
    "q": "Giữa phần tên và phần mở rộng của tệp được phân cách bởi:",
    "options": [
      "A. Dấu phẩy",
      "B. Dấu chấm",
      "C. Dấu hai chấm",
      "D. Dấu sao"
    ],
    "correct": "B"
  },
  {
    "id": 6,
    "q": "Phần mở rộng của tên tệp thường thể hiện:",
    "options": [
      "A. Thư mục chứa",
      "B. Kiểu tệp",
      "C. Kích thước",
      "D. Ngày tạo"
    ],
    "correct": "B"
  },
  {
    "id": 7,
    "q": "Việc sắp xếp tệp hợp lí giúp người dùng:",
    "options": [
      "A. Tăng dung lượng",
      "B. Dễ tìm và quản lí",
      "C. Cài phần mềm",
      "D. Tăng tốc mạng"
    ],
    "correct": "B"
  },
  {
    "id": 8,
    "q": "Facebook là mạng xã hội do ai sáng lập?",
    "options": [
      "A. Bill Gates",
      "B. Mark Zuckerberg",
      "C. Steve Jobs",
      "D. Elon Musk"
    ],
    "correct": "B"
  },
  {
    "id": 9,
    "q": "Facebook được ra đời vào năm nào?",
    "options": [
      "A. 2000",
      "B. 2004",
      "C. 2006",
      "D. 2010"
    ],
    "correct": "B"
  },
  {
    "id": 10,
    "q": "Độ tuổi tối thiểu được phép tạo tài khoản Facebook là:",
    "options": [
      "A. 10 tuổi",
      "B. 12 tuổi",
      "C. 13 tuổi",
      "D. 16 tuổi"
    ],
    "correct": "C"
  },
  {
    "id": 11,
    "q": "Facebook quy định độ tuổi sử dụng nhằm mục đích:",
    "options": [
      "A. Giới hạn người dùng",
      "B. Giảm nội dung",
      "C. Bảo vệ người dùng nhỏ tuổi",
      "D. Tăng lợi nhuận"
    ],
    "correct": "C"
  },
  {
    "id": 12,
    "q": "Khi tham gia mạng xã hội, học sinh nên:",
    "options": [
      "A. Tranh cãi",
      "B. Tôn trọng người khác",
      "C. Đăng tin sai",
      "D. Nói tục"
    ],
    "correct": "B"
  },
  {
    "id": 13,
    "q": "Thông tin nào không nên chia sẻ trên mạng xã hội?",
    "options": [
      "A. Thông tin cá nhân",
      "B. Ảnh phong cảnh",
      "C. Sở thích",
      "D. Hoạt động học tập"
    ],
    "correct": "A"
  },
  {
    "id": 14,
    "q": "Hành động nào sau đây là thiếu văn hóa nơi công cộng?",
    "options": [
      "A. Xin lỗi",
      "B. Giữ trật tự",
      "C. Xếp hàng",
      "D. Nói tục"
    ],
    "correct": "D"
  },
  {
    "id": 15,
    "q": "Ứng xử có văn hóa trên mạng giúp:",
    "options": [
      "A. Nổi tiếng",
      "B. Tạo môi trường lành mạnh",
      "C. Nhiều tranh luận",
      "D. Thể hiện cá tính"
    ],
    "correct": "B"
  },
  {
    "id": 16,
    "q": "Dấu hiệu nào cho thấy nguy cơ lừa đảo trên mạng?",
    "options": [
      "A. Cung cấp mật khẩu",
      "B. Tin nhắn báo số tiền hiện tại trong tài khoản",
      "C. Thông báo lớp",
      "D. Trang trường"
    ],
    "correct": "A"
  },
  {
    "id": 17,
    "q": "Khi nhận tin nhắn đáng ngờ, học sinh nên:",
    "options": [
      "A. Trả lời ngay lập tức",
      "B. Không phản hồi",
      "C. Chia sẻ",
      "D. Làm theo"
    ],
    "correct": "B"
  },
  {
    "id": 18,
    "q": "Để sử dụng mạng xã hội an toàn, học sinh cần:",
    "options": [
      "A. Kết bạn nhiều",
      "B. Giữ kín thông tin riêng tư",
      "C. Công khai dữ liệu",
      "D. Dùng nhiều tài khoản"
    ],
    "correct": "B"
  },
  {
    "id": 19,
    "q": "Khi bị bắt nạt trên mạng, học sinh nên:",
    "options": [
      "A. Im lặng không phản hồi",
      "B. Trả đũa lại",
      "C. Báo người lớn",
      "D. Đăng phản đối"
    ],
    "correct": "C"
  },
  {
    "id": 20,
    "q": "Việc học cách tránh rủi ro trên mạng giúp học sinh:",
    "options": [
      "A. Giải trí hơn",
      "B. Dùng mạng nhiều",
      "C. Bảo vệ bản thân",
      "D. Kết bạn nhanh"
    ],
    "correct": "C"
  },
  {
    "id": 21,
    "q": "Thiết bị nào sau đây dùng để nhập hình ảnh vào máy tính?",
    "options": [
      "A. Máy in",
      "B. Loa",
      "C. Webcam",
      "D. Máy chiếu"
    ],
    "correct": "C"
  },
  {
    "id": 22,
    "q": "Thiết bị nào sau đây không phải là thiết bị ra của máy tính?",
    "options": [
      "A. Bàn phím",
      "B. Màn hình",
      "C. Máy in",
      "D. Loa"
    ],
    "correct": "A"
  },
  {
    "id": 23,
    "q": "Một trong các chức năng của hệ điều hành là:",
    "options": [
      "A. Chơi game mượt",
      "B. Quản lí thiết bị",
      "C. Thiết kế đồ họa",
      "D. Nghe nhạc hay"
    ],
    "correct": "B"
  },
  {
    "id": 24,
    "q": "Trong hệ điều hành, thư mục là nơi dùng để:",
    "options": [
      "A. Ghi nhớ các chương trình ưa thích",
      "B. Chứa tệp và thư mục",
      "C. Xử lí dữ liệu",
      "D. Khởi động"
    ],
    "correct": "B"
  },
  {
    "id": 25,
    "q": "Tên tệp trong máy tính dùng để:",
    "options": [
      "A. Phân biệt các tệp",
      "B. Giảm dung lượng",
      "C. Tăng tốc máy tính",
      "D. Bảo vệ nội dung"
    ],
    "correct": "A"
  },
  {
    "id": 26,
    "q": "Khi đổi tên tệp, phần nào không nên thay đổi để tránh lỗi?",
    "options": [
      "A. Tên tệp",
      "B. Phần mở rộng",
      "C. Vị trí lưu",
      "D. Thư mục"
    ],
    "correct": "B"
  },
  {
    "id": 27,
    "q": "Việc đặt tên tệp rõ ràng giúp người dùng:",
    "options": [
      "A. Tăng dung lượng",
      "B. Dễ nhận biết",
      "C. Giảm lỗi",
      "D. Tăng tốc"
    ],
    "correct": "B"
  },
  {
    "id": 28,
    "q": "Facebook là mạng xã hội cho phép người dùng:",
    "options": [
      "A. Kết nối và chia sẻ",
      "B. Soạn thảo văn bản trực tuyến",
      "C. Cài phần mềm",
      "D. Lập trình"
    ],
    "correct": "A"
  },
  {
    "id": 29,
    "q": "Facebook ban đầu được tạo ra nhằm mục đích:",
    "options": [
      "A. Bán hàng đa cấp",
      "B. Kết nối sinh viên",
      "C. Chơi game trực tuyến",
      "D. Xem phim miễn phí"
    ],
    "correct": "B"
  },
  {
    "id": 30,
    "q": "Người dưới 13 tuổi dùng Facebook có nguy cơ:",
    "options": [
      "A. Không được bảo vệ",
      "B. Không dùng mạng",
      "C. Chậm máy",
      "D. Không tải app"
    ],
    "correct": "A"
  },
  {
    "id": 31,
    "q": "Tuân thủ độ tuổi khi dùng Facebook thể hiện:",
    "options": [
      "A. Sự nổi tiếng",
      "B. Ý thức sử dụng",
      "C. Kĩ năng công nghệ",
      "D. Mức độ online"
    ],
    "correct": "B"
  },
  {
    "id": 32,
    "q": "Khi bình luận trên mạng xã hội, học sinh nên:",
    "options": [
      "A. Gay gắt, thô lỗ",
      "B. Lịch sự",
      "C. Trêu chọc",
      "D. Theo cảm xúc"
    ],
    "correct": "B"
  },
  {
    "id": 33,
    "q": "Hành động nào thể hiện ứng xử có văn hóa trên mạng?",
    "options": [
      "A. Không bêu xấu hình ảnh của người khác",
      "B. Chia sẻ thông tin mang tính thêu dệt",
      "C. Không nghiện game",
      "D. Gây tranh cãi"
    ],
    "correct": "A"
  },
  {
    "id": 34,
    "q": "Đăng thông tin sai sự thật lên mạng là hành vi sai theo lời khuyên:",
    "options": [
      "A. Đừng vô tình ăn cắp trên không gian mạng",
      "B. Không lan truyền tin giả",
      "C. Bắt nạt tiếp tay cho kẻ bắt nạt là vi phạm pháp luật",
      "D. Cảnh giác với kẻ dụ dỗ và bắt nạt"
    ],
    "correct": "B"
  },
  {
    "id": 35,
    "q": "Ứng xử có văn hóa trên mạng giúp mỗi người:",
    "options": [
      "A. Trở nên nổi tiếng",
      "B. Được tôn trọng",
      "C. Nhiều bình luận",
      "D. Thể hiện cá tính"
    ],
    "correct": "B"
  },
  {
    "id": 36,
    "q": "Một trong những rủi ro khi dùng mạng xã hội là:",
    "options": [
      "A. Học tốt",
      "B. Bị lừa đảo",
      "C. Kết nối",
      "D. Trao đổi"
    ],
    "correct": "B"
  },
  {
    "id": 37,
    "q": "Để tránh bị lừa đảo trên mạng, học sinh không nên:",
    "options": [
      "A. Kiểm tra và đọc tin nhắn lạ",
      "B. Nhấn liên kết lạ",
      "C. Báo người lớn",
      "D. Cẩn thận"
    ],
    "correct": "B"
  },
  {
    "id": 38,
    "q": "Mật khẩu an toàn trên mạng xã hội cần:",
    "options": [
      "A. Khó đoán",
      "B. Dễ nhớ",
      "C. Trùng tên với thầy dạy thêm",
      "D. Ít kí tự"
    ],
    "correct": "A"
  },
  {
    "id": 39,
    "q": "Khi phát hiện tài khoản bị xâm nhập, người dùng nên:",
    "options": [
      "A. Bỏ qua và tạo tài khoản mới",
      "B. Đăng cảnh báo",
      "C. Đổi mật khẩu",
      "D. Tắt thiết bị"
    ],
    "correct": "C"
  },
  {
    "id": 40,
    "q": "Trang bị kiến thức an toàn thông tin giúp học sinh:",
    "options": [
      "A. Chơi game không bị thầy la",
      "B. Hạn chế rủi ro",
      "C. Truy cập nhanh",
      "D. Có nhiều tài khoản mạng xã hội"
    ],
    "correct": "B"
  }
];

        // --- STATE ---
        let sessionQuestions = [];
        let currentQuestion = 0;
        let userAnswers = new Array(30).fill(null);
        let userInfo = { name: "", class: "", id: "" };
        let timerInterval;
        let timeLeft = 600;

        // --- DOM ELEMENTS ---
        const screens = {
            login: document.getElementById('screen-login'),
            quiz: document.getElementById('screen-quiz'),
            result: document.getElementById('screen-result')
        };
        const els = {
            name: document.getElementById('input-name'),
            class: document.getElementById('input-class'),
            id: document.getElementById('input-id'),
            timer: document.getElementById('timer-display'),
            qCurrent: document.getElementById('q-current'),
            qText: document.getElementById('question-text'),
            optionsCont: document.getElementById('options-container'),
            progressBar: document.getElementById('progress-bar'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            toast: document.getElementById('toast'),
            scoreDisplay: document.getElementById('score-display'),
            scorePercent: document.getElementById('score-percent'),
            resultInfo: document.getElementById('result-info'),
            reviewList: document.getElementById('review-list'),
            modal: document.getElementById('confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body')
        };

        // --- HELPER FUNCTIONS ---
       
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showToast(message) {
            els.toast.textContent = message;
            els.toast.className = "show";
            setTimeout(function(){ els.toast.className = els.toast.className.replace("show", ""); }, 3000);
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        // --- MODAL FUNCTIONS ---
        function closeModal() {
            els.modal.classList.remove('active');
        }

        function checkSubmit() {
            // Count unanswered
            let unansweredCount = 0;
            userAnswers.forEach(ans => {
                if (ans === null) unansweredCount++;
            });

            if (unansweredCount > 0) {
                els.modalTitle.textContent = "Chưa hoàn thành!";
                els.modalBody.innerHTML = `Bạn còn <strong style="color:red">${unansweredCount}</strong> câu chưa trả lời.<br>Bạn có muốn nộp bài luôn không?`;
            } else {
                els.modalTitle.textContent = "Xác nhận nộp bài";
                els.modalBody.textContent = "Bạn đã làm xong tất cả câu hỏi. Bạn có chắc chắn muốn nộp không?";
            }
           
            els.modal.classList.add('active');
        }

        // --- CORE FUNCTIONS ---

        function prepareQuizData() {
            let questions = JSON.parse(JSON.stringify(rawQuestionsDB));
            shuffleArray(questions);
            questions.forEach(q => {
                const letterMap = {'A': 0, 'B': 1, 'C': 2, 'D': 3};
                const oldCorrectIndex = letterMap[q.correct];
                const originalContentArray = q.options.map(opt => opt.substring(3).trim());
                const correctContent = originalContentArray[oldCorrectIndex];
                shuffleArray(originalContentArray);
                q.newCorrectIndex = originalContentArray.indexOf(correctContent);
                q.cleanOptions = originalContentArray;
            });
            return questions;
        }

        // UPDATE: Hàm startQuiz có kiểm tra dữ liệu đầu vào
        function startQuiz() {
            const name = els.name.value.trim();
            const cls = els.class.value; // Giá trị từ dropdown
            const id = els.id.value.trim();
            const idNum = parseInt(id);

            // Kiểm tra xem đã điền đủ thông tin chưa
            if (!name || !cls || !id) {
                showToast("Vui lòng nhập đầy đủ: Họ tên, Lớp và STT!");
                return;
            }

            // Kiểm tra STT có hợp lệ không (từ 1 đến 55)
            if (isNaN(idNum) || idNum < 1 || idNum > 55) {
                showToast("Số thứ tự phải nằm trong khoảng từ 1 đến 55!");
                return;
            }

            userInfo = { name, class: cls, id };
            sessionQuestions = prepareQuizData();
            switchScreen('quiz');
            renderQuestion();
            startTimer();
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz(true); // Forced submit time out
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            els.timer.textContent = `${m}:${s}`;
            if (timeLeft < 60) els.timer.style.color = "red";
        }

        function renderQuestion() {
            const q = sessionQuestions[currentQuestion];
            els.qCurrent.textContent = currentQuestion + 1;
            els.qText.textContent = q.q;

            const percent = ((currentQuestion + 1) / sessionQuestions.length) * 100;
            els.progressBar.style.width = `${percent}%`;

            els.optionsCont.innerHTML = '';
           
            const labels = ['A', 'B', 'C', 'D'];
           
            q.cleanOptions.forEach((optText, index) => {
                const div = document.createElement('div');
                div.className = `option-card ${userAnswers[currentQuestion] === index ? 'selected' : ''}`;
                div.onclick = () => selectOption(index);
               
                const letterSpan = document.createElement('span');
                letterSpan.className = 'option-letter';
                letterSpan.textContent = labels[index] + ".";
               
                const textSpan = document.createElement('span');
                textSpan.textContent = optText;

                div.appendChild(letterSpan);
                div.appendChild(textSpan);
                els.optionsCont.appendChild(div);
            });

            els.btnPrev.disabled = currentQuestion === 0;
            els.btnPrev.style.opacity = currentQuestion === 0 ? "0.5" : "1";
           
            if (currentQuestion === sessionQuestions.length - 1) {
                els.btnNext.textContent = "Nộp bài";
                els.btnNext.classList.add("btn-submit");
            } else {
                els.btnNext.textContent = "Câu tiếp theo";
                els.btnNext.classList.remove("btn-submit");
            }
        }

        function selectOption(index) {
            userAnswers[currentQuestion] = index;
            const options = els.optionsCont.children;
            for (let i = 0; i < options.length; i++) {
                options[i].classList.remove('selected');
            }
            options[index].classList.add('selected');
        }

        function nextQuestion() {
            if (currentQuestion < sessionQuestions.length - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                checkSubmit();
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        function submitQuiz(forced = false) {
            clearInterval(timerInterval);
            closeModal();
           
            if (forced) showToast("Hết giờ! Đã tự động nộp bài.");
           
            let score = 0;
            const reviewHTML = [];
            const labels = ['A', 'B', 'C', 'D'];

            sessionQuestions.forEach((q, idx) => {
                const userChoiceIndex = userAnswers[idx];
                const correctIndex = q.newCorrectIndex;
               
                let isCorrect = false;
                if (userChoiceIndex === correctIndex) {
                    score++;
                    isCorrect = true;
                }

                let userText = userChoiceIndex !== null ? `${labels[userChoiceIndex]}. ${q.cleanOptions[userChoiceIndex]}` : "<span style='color:red'>Chưa trả lời</span>";
                let correctText = `${labels[correctIndex]}. ${q.cleanOptions[correctIndex]}`;

                reviewHTML.push(`
                    <div class="review-item">
                        <div class="review-q">Câu ${idx + 1}: ${q.q}</div>
                        <div class="review-ans ${isCorrect ? 'correct-ans' : 'wrong-ans'}">
                            <span class="user-ans-label">Bạn chọn:</span> ${userText}
                        </div>
                        ${!isCorrect ? `
                        <div class="review-ans correct-ans">
                            <span class="user-ans-label">Đáp án đúng:</span> ${correctText}
                        </div>` : ''}
                    </div>
                `);
            });

            switchScreen('result');
            // Show new user info format
            els.resultInfo.innerHTML = `Học sinh: <b>${userInfo.name}</b> - Lớp: <b>${userInfo.class}</b> - STT: <b>${userInfo.id}</b>`;
            els.scoreDisplay.textContent = `${score}/30`;
            const percentage = Math.round((score / 30) * 100);
           
            let color = percentage >= 50 ? "green" : "red";
            els.scorePercent.innerHTML = `<span style="color:${color}">(${percentage}%)</span> - ${score >= 15 ? "Đạt" : "Cần cố gắng hơn"}`;
           
            els.reviewList.innerHTML = reviewHTML.join('');
        }
    </script>
</body>
</html>
